# 要件定義書

## 概要

この機能は、Backend-for-Frontend（BFF）パターンとCookieベース認証を使用したNext.jsアプリケーション向けの安全な認証システムを実装します。システムは、アクセストークン（at）、リフレッシュトークン（rt）、CSRFトークンを使用した安全なトークン管理を提供します。アクセストークンとリフレッシュトークンは HTTP-only クッキーとして保存し、CSRF トークンはヘッダー送信用に JavaScript から参照可能なクッキーで保持します。このソリューションは、クライアントサイドのトークン保存の脆弱性を回避しながら、セキュリティ（OWASP ASVS L2準拠）、可用性、保守性を優先します。

## 要件

### 要件1

**ユーザーストーリー:** ユーザーとして、アプリケーションに安全にログインしたい。そうすることで、認証情報がXSSやCSRF攻撃から保護される。

#### 受け入れ基準

1. ユーザーが有効なログイン認証情報を送信した場合、システムは3つの安全なクッキーを発行する必要がある：アクセストークン（at）、リフレッシュトークン（rt）、CSRFトークン
2. クッキーが設定される場合、アクセストークンはHttpOnly、Secure、SameSite=Lax属性を持ち、15分の有効期限を持つ必要がある
3. クッキーが設定される場合、リフレッシュトークンはHttpOnly、Secure、SameSite=Strict属性を持ち、7日の有効期限とPath=/apiを持つ必要がある
4. クッキーが設定される場合、CSRFトークンはヘッダー包含のためにJavaScriptからアクセス可能である必要がある
5. ログイン認証情報が無効な場合、システムはクッキーを設定せずに適切なエラーレスポンスを返す必要がある

### 要件2

**ユーザーストーリー:** ユーザーとして、セッションが自動的に更新されることを望む。そうすることで、アプリケーションを積極的に使用している間にログアウトされることがない。

#### 受け入れ基準

1. API呼び出し中にアクセストークンが期限切れになった場合、システムはリフレッシュトークンを使用して自動的に更新を試行する必要がある
2. 更新が成功した場合、システムはユーザーの介入なしに新しいアクセストークンとCSRFトークンを発行する必要がある
3. リフレッシュトークンが無効または期限切れの場合、システムはユーザーをログインページにリダイレクトする必要がある
4. トークン更新が発生した場合、元のAPIリクエストは新しいアクセストークンで再試行される必要がある
5. 更新が失敗した場合、システムはすべての認証クッキーをクリアする必要がある

### 要件3

**ユーザーストーリー:** ユーザーとして、アプリケーションを通じて保護されたリソースにアクセスしたい。そうすることで、認証された機能を安全に使用できる。

#### 受け入れ基準

1. 保護されたページにアクセスする場合、システムはコンテンツをレンダリングする前に有効な認証を検証する必要がある
2. 保護されたエンドポイントへのAPI呼び出しを行う場合、システムは適切な認証ヘッダーを含める必要がある
3. 認証が欠如しているか無効な場合、システムはログインページにリダイレクトする必要がある
4. APIプロキシが認証されたリクエストを受信した場合、適切な認証ヘッダーを付けて上流APIにリクエストを転送する必要がある
5. 上流APIが401を返した場合、プロキシはクライアントにエラーを返す前にトークン更新を試行する必要がある

### 要件4

**ユーザーストーリー:** ユーザーとして、CSRF攻撃からの保護を望む。そうすることで、悪意のあるサイトが私の代わりにアクションを実行できない。

#### 受け入れ基準

1. 状態変更操作を実行する場合、システムはCSRFトークン検証を要求する必要がある
2. CSRFトークンが欠如しているか無効な場合、システムは403 Forbiddenレスポンスを返す必要がある
3. CSRFトークン検証が通過した場合、システムはリクエストを正常に処理する必要がある
4. 新しいセッションが作成される場合、システムは一意のCSRFトークンを生成する必要がある
5. CSRFトークンが期限切れになった場合、システムは更新中に新しいトークンを生成する必要がある

### 要件5

**ユーザーストーリー:** ユーザーとして、アプリケーションから安全にログアウトしたい。そうすることで、セッションが適切に終了される。

#### 受け入れ基準

1. ユーザーがログアウトを開始した場合、システムはすべての認証クッキーをクリアする必要がある
2. ログアウトが発生した場合、システムはサーバーサイドでリフレッシュトークンを無効化する必要がある
3. ログアウトが完了した場合、システムはユーザーをログインページにリダイレクトする必要がある
4. クッキーがクリアされる場合、過去の有効期限日で設定される必要がある
5. ログアウトが失敗した場合でも、システムはセキュリティのためにクライアントサイドクッキーをクリアする必要がある

### 要件6

**ユーザーストーリー:** 開発者として、包括的なセキュリティ対策を実装したい。そうすることで、アプリケーションがOWASP ASVS L2セキュリティ標準を満たす。

#### 受け入れ基準

1. アプリケーションが実行される場合、Content Security Policyヘッダーを実装する必要がある
2. リクエストを処理する場合、システムは悪用を防ぐためにレート制限を適用する必要がある
3. エラーが発生した場合、システムは機密情報を公開せずにセキュリティイベントをログに記録する必要がある
4. 本番環境では、システムは安全なクッキー属性とHTTPS強制を使用する必要がある
5. セキュリティ脆弱性が検出された場合、システムは監視とアラート機能を持つ必要がある

### 要件7

**ユーザーストーリー:** 開発者として、適切なエラーハンドリングと監視を望む。そうすることで、認証システムを効果的に保守およびトラブルシューティングできる。

#### 受け入れ基準

1. 認証エラーが発生した場合、システムはデバッグのために適切な詳細をログに記録する必要がある
2. システムエラーが発生した場合、ユーザー向けメッセージは内部実装の詳細を公開してはならない
3. システムを監視する場合、認証成功/失敗率の主要メトリクスが利用可能である必要がある
4. 問題をデバッグする場合、機密データを公開せずに包括的なログが利用可能である必要がある
5. 重大なエラーが発生した場合、システムはアラート機能を持つ必要がある

### 要件8

**ユーザーストーリー:** 開発者として、適切なテストを伴う保守可能なコードベースを望む。そうすることで、認証システムを確実に更新および拡張できる。

#### 受け入れ基準

1. コードが書かれる場合、80%以上のカバレッジを持つ包括的な単体テストを持つ必要がある
2. 統合ポイントが存在する場合、主要な認証フローをカバーする統合テストを持つ必要がある
3. ユーザーフローが実装される場合、ログイン、ログアウト、保護されたアクセスをカバーするエンドツーエンドテストを持つ必要がある
4. コードがコミットされる場合、すべてのリンティング、型チェック、テスト要件を通過する必要がある
5. テストが失敗した場合、CI/CDパイプラインは本番環境への展開を防ぐ必要がある
