# 実装計画

本ファイルを進捗管理の唯一のソースとする（最終更新: 2025-08-30）。

- [x] 1. プロジェクト基盤の構築
  - ワークスペース構成とpackage.json設定を作成
  - Nodeバージョンを固定（`.nvmrc` または `.node-version`）
  - pnpmワークスペースを定義（`api/`, `clients/web`）
  - TypeScript、ESLint、Prettierの初期設定を実装（Huskyなし）
  - Vitest、Playwrightのテスト環境を構築
  - `.env.example` を用意し、ランタイム環境変数のバリデーションスキーマ（zod等）を実装
  - GitHub Actions CI/CDパイプラインを設定
  - _要件: 8.4, 8.5_

- [x] 2. 認証ユーティリティとモデルの実装
  - [x] 2.1 TypeScript型定義とインターフェースの作成
    - AuthTokens、LoginCredentials、User、Sessionの型定義を実装
    - CookieConfig、AuthError、SecurityLogの型定義を作成
    - 各コンポーネントのインターフェース定義を実装
    - _要件: 1.1, 1.2, 1.3_

  - [x] 2.2 Cookie管理ユーティリティの実装
    - setAuthCookies、clearAuthCookies関数を実装
    - Cookie設定（HttpOnly、Secure、SameSite）の適用
    - アクセストークン、リフレッシュトークン、CSRFトークンの個別管理
    - Cookie管理の単体テストを作成
    - _要件: 1.2, 1.3, 1.4_

  - [x] 2.3 トークン検証とセッション管理の実装
    - JWT検証ロジックまたは不透明トークン検証を実装
    - セッション情報の取得と検証機能を作成
    - トークン有効期限チェック機能を実装
    - セッション管理の単体テストを作成
    - _要件: 2.2, 3.1, 3.2_

- [ ] 3. 認証APIエンドポイントの実装
  - [ ] 3.1 ログインエンドポイントの実装
    - /api/auth/loginルートを作成
    - 上流APIへの認証情報転送機能を実装
    - 成功時のCookie設定とユーザー情報返却を実装
    - 失敗時のエラーハンドリングを実装
    - ログインエンドポイントの単体テストを作成
    - _要件: 1.1, 1.5_

  - [ ] 3.2 リフレッシュエンドポイントの実装
    - /api/auth/refreshルートを作成
    - リフレッシュトークンの検証と新トークン発行を実装
    - トークンローテーション機能を実装
    - ワンタイム使用のRT無効化（リプレイ対策）と保存先（例: Redis）を実装
    - リフレッシュ失敗時のCookieクリア処理を実装
    - リフレッシュエンドポイントの単体テストを作成
    - _要件: 2.1, 2.2, 2.5_

  - [ ] 3.3 ログアウトエンドポイントの実装
    - /api/auth/logoutルートを作成
    - サーバーサイドでのトークン無効化を実装
    - 全認証Cookieのクリア処理を実装
    - ログアウト後のリダイレクト処理を実装
    - ログアウトエンドポイントの単体テストを作成
    - _要件: 5.1, 5.2, 5.3, 5.4_

  - [ ] 3.4 CSRFトークンエンドポイントの実装
    - /api/auth/csrfルートを作成
    - CSRFトークンの生成と配布機能を実装
    - CSRFトークンの検証ミドルウェアを作成
    - CSRF保護の単体テストを作成
    - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 4. APIプロキシ層の実装
  - [ ] 4.1 基本プロキシ機能の実装
    - /api/proxy/*ルートの動的ルーティングを作成
    - 上流APIへのリクエスト転送機能を実装
    - レスポンスの適切な返却処理を実装
    - プロキシ基本機能の単体テストを作成
    - _要件: 3.4_

  - [ ] 4.2 認証ヘッダー注入機能の実装
    - アクセストークンの取得と検証を実装
    - Authorizationヘッダーの自動付与機能を作成
    - 認証失敗時の適切なエラーレスポンスを実装
    - 認証ヘッダー注入の単体テストを作成
    - _要件: 3.2, 3.4_

  - [ ] 4.3 401エラーハンドリングとリトライ機能の実装
    - 上流APIからの401レスポンス検知を実装
    - 自動トークンリフレッシュ機能を実装
    - リフレッシュ後のリクエスト再試行を実装
    - リトライ機能の単体テストを作成
    - _要件: 2.1, 2.4, 3.5_

- [ ] 5. クライアントサイド認証基盤の実装
  - [ ] 5.1 Next.jsクライアントアプリケーションの初期化
    - clients/webディレクトリにNext.jsプロジェクトを作成
    - 基本的なページ構造（pages/index.tsx、pages/login.tsx）を実装
    - 必要な依存関係（React Query、Axios等）をインストール
    - クライアントアプリケーションの基本設定を完了
    - _要件: 3.1, 3.3_

  - [ ] 5.2 認証コンテキストとフックの実装
    - AuthContextとAuthProviderを作成
    - useSessionフックを実装
    - ユーザー状態管理とローディング状態を実装
    - 認証状態の永続化機能を実装
    - 認証コンテキストの単体テストを作成
    - _要件: 3.1, 3.2_

  - [ ] 5.3 withAuthPage HOCの実装
    - 保護ページ用のHOCを作成
    - サーバーサイドでの認証チェック機能を実装
    - 未認証時のログインページリダイレクトを実装
    - 認証済みユーザーのページアクセス制御を実装
    - withAuthPageの単体テストを作成
    - _要件: 3.1, 3.3_

  - [ ] 5.4 基本ページコンポーネントの実装
    - ログインページ（/login）を作成
    - 保護されたダッシュボードページを作成
    - ログイン/ログアウト機能を持つナビゲーションを実装
    - 基本的なUI/UXを実装
    - ページコンポーネントの単体テストを作成
    - _要件: 1.1, 3.1, 5.3_

- [ ] 6. クライアントサイドAPIクライアントの実装
  - [ ] 6.1 HTTP クライアントラッパーの実装
    - Axiosベースのカスタムクライアントを作成
    - CSRFトークンの自動ヘッダー付与機能を実装
    - リクエスト/レスポンスインターセプターを実装
    - HTTPクライアントの単体テストを作成
    - _要件: 4.1, 4.3_

  - [ ] 6.2 401エラー自動リフレッシュ機能の実装
    - 401レスポンス検知とリフレッシュトリガーを実装
    - リフレッシュ成功時の元リクエスト再試行を実装
    - リフレッシュ失敗時のログアウト処理を実装
    - 同時リクエストでのリフレッシュ重複防止を実装
    - 自動リフレッシュ機能の単体テストを作成
    - _要件: 2.1, 2.4, 2.5_

  - [ ] 6.3 React Query統合の実装
    - 認証付きAPIクエリのカスタムフックを作成
    - エラーハンドリングとリトライ戦略を実装
    - キャッシュ無効化とデータ同期を実装
    - React Query統合の単体テストを作成
    - _要件: 2.1, 3.2_

- [ ] 7. セキュリティ強化機能の実装
  - [ ] 7.1 セキュリティヘッダーとCSPの実装
    - helmetミドルウェアを設定
    - Content Security Policyを実装
    - XSS、CSRF、クリックジャッキング対策を実装
    - セキュリティヘッダーの設定テストを作成
    - _要件: 6.1, 6.4_

  - [ ] 7.2 レート制限機能の実装
    - ログインエンドポイントのレート制限を実装
    - APIエンドポイント全体のレート制限を実装
    - Redis/メモリベースのレート制限ストアを設定
    - レート制限機能の単体テストを作成
    - _要件: 6.2_

  - [ ] 7.3 セキュリティログとモニタリングの実装
    - セキュリティイベントのログ記録機能を実装
    - 認証失敗、CSRF違反、レート制限のログを実装
    - 機密情報を除外したログフォーマットを実装
    - セキュリティログの単体テストを作成
    - _要件: 6.3, 7.1, 7.2_

- [ ] 8. 統合テストとE2Eテストの実装
  - [ ] 8.1 認証フロー統合テストの作成
    - ログイン→保護ページアクセス→ログアウトの統合テストを作成
    - トークンリフレッシュフローの統合テストを作成
    - CSRF保護の統合テストを作成
    - 統合テストの実行環境を設定
    - _要件: 8.2_

  - [ ] 8.2 E2Eテストスイートの作成
    - Playwrightを使用したユーザーフローテストを作成
    - ログイン/ログアウトのE2Eテストを実装
    - 保護ページアクセスのE2Eテストを実装
    - 自動リフレッシュのE2Eテストを実装
    - _要件: 8.3_

  - [ ] 8.3 パフォーマンステストの実装
    - 認証エンドポイントの負荷テストを作成
    - 同時セッション管理のテストを実装
    - メモリリークとパフォーマンス監視を実装
    - パフォーマンステストの自動化を設定
    - _要件: 7.3_

- [ ] 9. 本番環境対応とドキュメント整備
  - [ ] 9.1 環境変数とデプロイ設定の実装
    - 本番/ステージング/開発環境の設定を作成
    - 環境変数のバリデーションスキーマを実装
    - Docker/Kubernetes設定ファイルを作成
    - デプロイメント自動化スクリプトを作成
    - _要件: 6.4, 6.5_

  - [ ] 9.2 監視とアラート機能の実装
    - アプリケーションメトリクスの収集を実装
    - ヘルスチェックエンドポイントを作成
    - エラー率とレスポンス時間の監視を実装
    - 重要なセキュリティイベントのアラートを設定
    - _要件: 7.4, 7.5_

  - [ ] 9.3 運用ドキュメントの作成
    - API仕様書とエンドポイント一覧を作成
    - セキュリティ設定とベストプラクティスを文書化
    - トラブルシューティングガイドを作成
    - 運用手順書（デプロイ、監視、障害対応）を作成
    - _要件: 7.1, 7.2_
